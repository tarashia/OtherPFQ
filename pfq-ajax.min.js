// js/index/jscore/ajax.min.js
// PFQ's custom ajax library ONLY for testing userscripts - code (c) PFQ
'use strict';(function(){function k(f,a,e){var d="farm/notices"==f?-1:c?c.length:0;l.push([f,a,e,d]);c&&-1<d&&c.push({id:d,file:f,data:a,status:"queued",code:-1,response:null});1==l.length&&n()}function n(){0!=l.length&&q.apply(null,l[0])}function q(f,a,e,d){c&&c[d]&&(c[d].status="inprogress");var m=$.ajax({cache:!1,contentType:"application/json",data:JSON.stringify("undefined"==typeof a?null:a),dataType:"json",headers:{"X-Requested-With":"Love"},method:"POST",timeout:1E4,url:"/"+f.replace(/^\//,
"")});m.done(function(b){c&&c[d]&&(c[d].status="complete",c[d].code="200 OK",c[d].response=b);if(b.ok)e.success&&e.success(b);else if(!(e.failure&&!e.failure(b)||b.login&&0!=$("#relogin").length)&&(b.stack?new Dialog("Error!",(b.prepend||"")+"<p>An internal error has occurred.</p><p>Message: "+b.error+"</p>"+(b.append||""),[{text:"Copy error log",action:function(g,r){g=$("<div>");var h=$("<textarea>");h.addClass("fullwidth").css("height","100px");h.val(b.stack);h.appendTo(g);h=$("<p>");h.text("Copy this code when reporting the error, it should help find the problem!");
h.appendTo(g);r.replaceWith(g);return!1}},{text:"Close",right:!0}]):new Dialog("Error!",(b.prepend||"")+"<p>"+b.error+"</p>"+(b.append||""),[{text:"Close",right:!0}]),b.login))$("#relogin").on("click",function(){$.login(!0)})});m.fail(function(b,g){c&&c[d]&&(c[d].status="failed",c[d].code=b.status+" "+b.statusText,c[d].response={ok:!1,error:g});if(!(100>b.status&&p))if(429==b.status)"farm/notices"!=f&&function(){setTimeout(function(){k(f,a,e)},1E3*(b.getResponseHeader("retry-after")||5))}();else if(503==
b.status&&b.statusText.match(/backup/i))setTimeout(function(){k(f,a,e)},4E3);else if(0==b.status&&"error"==g)setTimeout(function(){k(f,a,e)},1E3);else if(!e.failure||e.failure({ok:!1,error:g}))"timeout"==g?new Dialog("Request timeout",'<p>The server did not respond in time.</p><p>Retry request? (Note that this <i>may</i> lead to duplicate transactions, proceed with care!)</p><p class="small">(Failed to load: '+f+")</p>",[{text:"Retry",action:function(){k(f,a,e)}},"cancel"]):0==b.status?new Dialog("Error!",
"<p>A network error has occurred.</p><p>Message: "+g+" "+b.status+" "+b.statusText+"</p><p>Please try again. If the error persists, report it.</p>",[{text:"Close",right:!0}]):new Dialog("Error!","<p>A system error has occurred.</p><p>Message: "+g+" "+b.status+" "+b.statusText+"</p><p>Please try again. If the error persists, report it.</p>",[{text:"Close",right:!0}])});m.complete(function(){e.complete&&e.complete();l.shift();n()})}var l=[],p=!1,c=null;$(window).on("unload",function(){p=!0});localStorage[$("#core").data("user")+
".debugmode"]&&(c=[]);window.ajax=function(f,a){var e={success:null,failure:null,complete:null};k(f,a,e);return{success:function(d){e.success=d;return this},failure:function(d){e.failure=d;return this},complete:function(d){e.complete=d;return this}}};c&&function(){var f=$("<li>");f.html('<a href="#"><img src="data:image/svg+xml;base64,'+window.btoa("<svg viewBox='-8 -8 16 16' xmlns='http://www.w3.org/2000/svg'><defs><mask id='debug_gear'><circle r='5' fill='#fff' stroke='#fff' stroke-width='2' stroke-dasharray='2.618' transform='rotate(15)'></circle><circle r='2' fill='#000'></circle></mask></defs><rect x='-7' y='-7' width='14' height='14' fill='"+
$("#announcements").css("color")+"' mask='url(#debug_gear)'></rect></svg>")+'" /> Debug</a>');$("#announcements>ul>li").eq(0).after(f);f.find(">a").on("click",function(){(new Dialog("AJAX Debug","<p>AJAX requests: "+c.length+'</p><ul id="ajaxdebuglist"><li class="thead"><span>ID / File</span><span>Status</span><span>Code</span></li>'+$.map(100<c.length?c.slice(c.length-100):c,function(a){return'<li><a href="#" data-debug="'+a.id+'">#'+(a.id+1)+": "+a.file+"</a><span>"+a.status[0].toUpperCase()+a.status.substr(1)+
"</span><span>"+a.code+"</span></li>"}).join("")+"</ul>",[{text:"Close",right:!0}])).opened(function(){$("#ajaxdebuglist").on("click","a[data-debug]",function(){var a=c[$(this).data("debug")];a&&new Dialog("AJAX Debug: "+(a.id+1),"<p>Debug item #"+(a.id+1)+": "+a.file+'</p><p>Data sent:<textarea class="fullwidth" style="height:200px;font-family:monospace">'+JSON.stringify(a.data,null,2)+"</textarea></p><p>Status: "+a.status[0].toUpperCase()+a.status.substr(1)+" / "+a.code+'</p><p>Data received:<textarea class="fullwidth" style="height:200px;font-family:monospace">'+
JSON.stringify(a.response,null,2)+"</textarea></p>",[{text:"Close",right:!0}])})})})}()})();
